<script>
let Redips = function () {
  let rd = this.rd = REDIPS.drag;
  rd.init('my-redips');
  rd.hover.colorTd = '#c0c0c0';

  const getDuplucated = function (index, element) {
    return element.textContent === rd.obj.textContent;
  };

  rd.event.droppedBefore = function (targetCell) {
    let source = $(rd.td.source);
    let target = $(targetCell);
    let div = $(rd.obj);
    if (target.data('id') === source.data('id')) {
      return true;
    }

    let duplucated = target.children().filter(getDuplucated);
    if (duplucated.length > 0) {
      toastr.error(`${div.text()}已存在該堂課`);
      return false;
    }

    duplucated = $(`.w${target.data('weekday')} div`).filter(getDuplucated);
    if (duplucated.length > 0) {
      let weekday = duplucated.parent().data('weekday');
      let period = duplucated.parent().data('period');
      toastr.error(`${div.text()}已存在在${PERIODS[period-1]}`);
      return false;
    }

    if (rd.td.target.childNodes.length >= 4) {
      toastr.warning(`該時段太多人`);
    }
  };

  rd.event.dropped = function (targetCell) {
    let sourceTd = $(rd.td.source);
    let targetTd = $(targetCell);
    let currentDiv = $(rd.obj);

    if (sourceTd.children().length < 4) {
      sourceTd.removeClass('full');
    }
    if (targetTd.children().length >= 4) {
      targetTd.addClass('full');
    }
  };
};
</script>