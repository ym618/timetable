<script>
const Modal = function (view) {
  const logger = new Logger('modal');

  view.modal.input = {};
  let sid    = view.modal.input.sid    = $('#modal-student-id input');
  let sName  = view.modal.input.sName  = $('#modal-student-name input');
  let isEval = view.modal.input.isEval = $('#modal-is-evaluate input');
  let groups = view.modal.input.groups = $('#modal-groups .circular');

  let onApprove = {
    onApprove: function() {
      if (sid.val().length === 0) {
        toastr.error(`病歷號不得為空`);
        sid.focus();
        return false;
      }

      if (sName.val().length === 0) {
        toastr.error(`姓名不得為空`);
        sName.focus();
        return false;
      }

      $('.schedule').each(function (index, element) {
        const period = new JQueryTd(element);
     
        let isExist = false;
        view.main.table.divs[sid.val()].forEach(function (div) {
          const p = new JQueryTd(div.parent());
          if (period.weekday === p.weekday && period.period === p.period) {
            div.addClass('tmpSchedule');
            return isExist = true;
          }
        });

        if (!isExist && view.main.table.divs[sid.val()].length > 0) {
          const newDiv = view.main.table.createDiv(new Student(view.main.table.divs[sid.val()][0].text()));
          newDiv.addClass('tmpSchedule');
          view.main.table.divs[sid.val()].push(newDiv);
          view.main.table.tds[period.weekday-1][period.period-1].append(newDiv);
          if (index >= 3) tds[period.weekday-1][period.period-1].addClass('full');

          console.log(period, view.main.table.tds[period.weekday-1][period.period-1])
          //period.save();
        }
      });

      view.main.table.divs[sid.val()].forEach(function (div) {
        if (div.hasClass('tmpSchedule')) {
          div.removeClass('tmpSchedule');
        } else {
          //div.remove();
          console.log(div)
        }
      });
    }
  };

  let setSchedule = function (td) {
    let period = new JQueryTd(td);
    view.modal.table.tds[period.weekday-1][period.period-1].addClass('schedule');
  };

  let setGroup = function (group) {
    let color = GROUP_MAP[group];
    groups.addClass('empty');
    $(`#modal-groups .${color}`).removeClass('empty');
  };

  $('#main-table td').click(function (event) {
    $('.schedule').removeClass('schedule');
        
    let target = $(event.target)
    switch(target.prop('tagName')) {
      case 'A':
        target = new JQueryDiv(target.parent());

        $('.ui.modal div.header').text('編輯個案');
        sid.val(target.sid).prop('disabled', true);
        sName.val(target.name);
        isEval.prop('checked', target.evaluate);
        setGroup(target.group);

        view.main.table.divs[target.sid].forEach(function (div, index) {
          setSchedule(div.parent());
        });
        break;
      case 'SPAN': return;
        target = target.parent();
      case 'DIV': return;
        target = target.parent();
      case 'TD': return;
        $('.ui.modal div.header').text('新增個案');
        sid.val('');
        sName.val('');
        isEval.prop('checked', false);
        groups.addClass('empty');

        setSchedule(target);
        break;
    }

    $('.ui.modal.editor').modal(onApprove).modal('show');
  });
  
  $('#modal-table td').click(function (event) {
    let target = new JQueryTd(event.target);
    target.inSchedule ? target.removeClass('schedule') : target.addClass('schedule');
  });

  // $('.ui.modal').modal('show');
};
</script>